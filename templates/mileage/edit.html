{% extends "base.html" %}

{% block title %}Edit Mileage{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="content-card mt-4">
            <div class="text-center mb-4">
                <div class="mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="#2596be" class="bi bi-pencil-square" viewBox="0 0 16 16">
                        <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                        <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/>
                    </svg>
                </div>
                <h2 class="fw-bold">Edit Mileage Record</h2>
                <p class="text-muted">Update your mileage submission</p>
                <div class="alert alert-info">
                    <strong>Edit Limit:</strong> You have {% if record.edit_count == 0 %}2{% elif record.edit_count == 1 %}1{% else %}0{% endif %} edit(s) remaining for this record.
                </div>
            </div>

            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show mb-4" role="alert">
                        <div class="d-flex align-items-center">
                            {% if message.tags == 'success' %}
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-check-circle-fill me-2" viewBox="0 0 16 16">
                                    <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                                </svg>
                            {% elif message.tags == 'error' or message.tags == 'danger' %}
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-exclamation-triangle-fill me-2" viewBox="0 0 16 16">
                                    <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                                </svg>
                            {% elif message.tags == 'warning' %}
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-exclamation-circle-fill me-2" viewBox="0 0 16 16">
                                    <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8 4a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0l.35-3.507A.905.905 0 0 0 8 4zm.002 6a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/>
                                </svg>
                            {% else %}
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-info-circle-fill me-2" viewBox="0 0 16 16">
                                    <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                                </svg>
                            {% endif %}
                            <div>{{ message }}</div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}

            <form method="post" enctype="multipart/form-data" class="mb-4">
                {% csrf_token %}

                <!-- Start KM -->
                <div class="mb-4">
                    <label for="{{ form.start_km.id_for_label }}" class="form-label fw-semibold">
                        Start KM <span class="text-danger">*</span>
                    </label>
                    <input type="number" name="start_km" id="{{ form.start_km.id_for_label }}"
                           value="{{ record.start_km }}" class="form-control" step="1" min="0" required>
                    <div class="form-text">Enter the starting kilometer reading</div>
                </div>

                <!-- End KM -->
                <div class="mb-4">
                    <label for="{{ form.end_km.id_for_label }}" class="form-label fw-semibold">
                        End KM <span class="text-danger">*</span>
                    </label>
                    <input type="number" name="end_km" id="{{ form.end_km.id_for_label }}"
                           value="{{ record.end_km }}" class="form-control" step="1" min="0" required>
                    <div class="form-text">Enter the ending kilometer reading</div>
                </div>

                <!-- Start Photo -->
                <div class="mb-4">
                    <label for="{{ form.start_photo.id_for_label }}" class="form-label fw-semibold">
                        Start Photo <span class="text-danger">*</span>
                    </label>
                    <div class="mb-3">
                        {% if record.start_photo %}
                        <div class="mb-2">
                            <small class="text-muted">Current photo:</small>
                            <img src="{{ record.start_photo.url }}" alt="Current start photo" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                        </div>
                        {% endif %}
                        <input type="file" name="start_photo" id="{{ form.start_photo.id_for_label }}"
                               class="form-control" accept="image/*">
                        <div class="form-text">Upload a new photo if you want to replace the current one</div>
                    </div>
                </div>

                <!-- End Photo -->
                <div class="mb-4">
                    <label for="{{ form.end_photo.id_for_label }}" class="form-label fw-semibold">
                        End Photo <span class="text-danger">*</span>
                    </label>
                    <div class="mb-3">
                        {% if record.end_photo %}
                        <div class="mb-2">
                            <small class="text-muted">Current photo:</small>
                            <img src="{{ record.end_photo.url }}" alt="Current end photo" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                        </div>
                        {% endif %}
                        <input type="file" name="end_photo" id="{{ form.end_photo.id_for_label }}"
                               class="form-control" accept="image/*">
                        <div class="form-text">Upload a new photo if you want to replace the current one</div>
                    </div>
                </div>

                

                <!-- Action Buttons -->
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary me-md-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left me-2" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M15 8a.5.5 0 0 1-.5.5H2.707l3.147 3.146a.5.5 0 0 1-.708.708l-4-4a.5.5 0 0 1 0-.708l4-4a.5.5 0 0 1 .708.708L2.707 7.5H14.5A.5.5 0 0 1 15 8z"/>
                        </svg>
                        Back to Dashboard
                    </a>
                    <button type="submit" name="action" value="submit" class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle me-2" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 7 7zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 8z"/>
                            <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
                        </svg>
                        Update Mileage
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.1.1/compressor.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const addInput = document.getElementById('id_images');
    const addDrop = document.getElementById('additional-photo-dropzone');
    const addPreview = document.getElementById('additional-photos-preview');

    function renderAdditionalPreviews(files) {
        addPreview.innerHTML = '';
        Array.from(files).forEach(file => {
            if (!file.type.startsWith('image/')) return;
            const container = document.createElement('div');
            container.style.width = '110px';
            container.style.textAlign = 'center';

            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            img.classList.add('img-thumbnail');
            img.style.maxWidth = '100%';
            img.style.height = '80px';
            img.style.objectFit = 'cover';

            const name = document.createElement('div');
            name.className = 'small text-muted mt-1 text-truncate';
            name.style.maxWidth = '100px';
            name.textContent = file.name;

            container.appendChild(img);
            container.appendChild(name);
            addPreview.appendChild(container);
        });
    }

    if (addDrop && addInput) {
        addDrop.addEventListener('click', function() { addInput.click(); });
        addInput.addEventListener('change', function(e) {
            renderAdditionalPreviews(e.target.files);
        });

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(ev => {
            addDrop.addEventListener(ev, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(ev => {
            addDrop.addEventListener(ev, function() {
                addDrop.classList.add('border-primary', 'border-2');
            }, false);
        });

        ['dragleave', 'drop'].forEach(ev => {
            addDrop.addEventListener(ev, function() {
                addDrop.classList.remove('border-primary', 'border-2');
            }, false);
        });

        addDrop.addEventListener('drop', function(e) {
            const files = e.dataTransfer.files;
            if (files.length) {
                const dataTransfer = new DataTransfer();
                Array.from(files).forEach(f => dataTransfer.items.add(f));
                addInput.files = dataTransfer.files;
                renderAdditionalPreviews(addInput.files);
            }
        }, false);
    }
});
</script>

<style>
    .file-upload-area {
        background-color: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .file-upload-area:hover {
        background-color: #f0f7ff;
        border-color: #2596be;
    }
    
    .border-dashed {
        border-style: dashed !important;
    }
</style>

{% endblock %}